<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AITL Control Flow Demo</title>
<style>
body {
  background:#020617;
  color:#e5e7eb;
  font-family: monospace;
  margin:0;
  padding:20px;
}
h1 { font-size:16px; margin-bottom:6px; }
#state { margin-bottom:10px; }

svg {
  background:#020617;
  border:1px solid #334155;
}

.pid { stroke:#38bdf8; fill:none; stroke-width:2; }
.set { stroke:#64748b; stroke-dasharray:4 4; fill:none; }
</style>
</head>

<body>

<h1>AITL Control Flow Demo</h1>
<div id="state">PID: Tracking target</div>

<svg width="640" height="240" viewBox="0 0 640 240">
  <path id="setpoint" class="set"/>
  <path id="pid" class="pid"/>
</svg>

<script>
const pidPath = document.getElementById("pid");
const setPath = document.getElementById("setpoint");
const stateText = document.getElementById("state");

const pidPoints = [];
const setPoints = [];

let t = 0;
let Kp = 1.0;
let disturbed = false;
let llmAdjusted = false;

function X(t) { return 20 + t * 5; }
function Y(v) { return 200 - v * 100; }

function buildPath(points) {
  if (points.length < 2) return "";
  return "M " + points.map(p => `${p.x} ${p.y}`).join(" L ");
}

function step() {
  t++;

  const set = 1.0;
  let y = set * (1 - Math.exp(-Kp * t / 15));

  // 外乱
  if (t > 35 && t < 55) {
    y -= 0.6;
    disturbed = true;
    stateText.textContent = "FSM: Disturbance detected";
  }

  // LLM介入
  if (t === 70) {
    Kp = 2.2;
    llmAdjusted = true;
    stateText.textContent = "LLM: PID gain re-tuned";
  }

  // 復帰
  if (t > 90) {
    stateText.textContent = "PID: Re-tracking target";
  }

  pidPoints.push({ x: X(t), y: Y(y) });
  setPoints.push({ x: X(t), y: Y(set) });

  pidPath.setAttribute("d", buildPath(pidPoints));
  setPath.setAttribute("d", buildPath(setPoints));

  if (t < 110) requestAnimationFrame(step);
}

step();
</script>

</body>
</html>
