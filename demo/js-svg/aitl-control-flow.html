<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AITL Control Flow Demo</title>
<style>
body {
  background:#020617;
  color:#e5e7eb;
  font-family: monospace;
  margin:0;
  padding:20px;
}

h1 { font-size:16px; margin-bottom:8px; }

.panel {
  display:flex;
  gap:24px;
}

.status {
  min-width:260px;
  font-size:13px;
  line-height:1.6;
}

.status div {
  margin-bottom:6px;
}

svg {
  background:#020617;
  border:1px solid #334155;
}

.pid { stroke:#38bdf8; fill:none; stroke-width:2; }
.set { stroke:#64748b; stroke-dasharray:4 4; fill:none; }

.disturb-zone {
  fill:rgba(239,68,68,0.18);
}
</style>
</head>

<body>

<h1>AITL Control Flow Demo</h1>

<div class="panel">

  <div class="status">
    <div id="pid">PID: tracking target</div>
    <div id="fsm">FSM: monitoring | error = 0.00</div>
    <div id="llm">LLM: idle</div>
  </div>

  <svg width="640" height="240" viewBox="0 0 640 240">
    <!-- 外乱ゾーン -->
    <rect id="disturbZone" class="disturb-zone"
          x="200" y="20" width="120" height="200"
          visibility="hidden"/>

    <!-- 波形 -->
    <path id="setpoint" class="set"/>
    <path id="pidPath" class="pid"/>
  </svg>

</div>

<script>
const pidText = document.getElementById("pid");
const fsmText = document.getElementById("fsm");
const llmText = document.getElementById("llm");

const pidPath = document.getElementById("pidPath");
const setPath = document.getElementById("setpoint");
const disturbZone = document.getElementById("disturbZone");

const pidPoints = [];
const setPoints = [];

let t = 0;
let Kp = 1.0;
let disturbed = false;
let llmAdjusted = false;

const SETPOINT = 1.0;
const ERROR_THRESHOLD = 0.4;

function X(t) { return 20 + t * 5; }
function Y(v) { return 200 - v * 100; }

function buildPath(points) {
  if (points.length < 2) return "";
  return "M " + points.map(p => `${p.x} ${p.y}`).join(" L ");
}

function step() {
  t++;

  // PID 応答（擬似）
  let y = SETPOINT * (1 - Math.exp(-Kp * t / 15));

  // 外乱注入
  if (t > 35 && t < 55) {
    y -= 0.6;
    disturbed = true;
    disturbZone.setAttribute("visibility", "visible");
  }

  // 誤差計算
  const error = Math.abs(SETPOINT - y);
  fsmText.textContent =
    `FSM: monitoring | error = ${error.toFixed(2)}`;

  // FSM 検出
  if (error > ERROR_THRESHOLD && !llmAdjusted) {
    fsmText.textContent =
      `FSM: disturbance detected | error = ${error.toFixed(2)}`;
    pidText.textContent = "PID: degraded tracking";
  }

  // LLM 介入
  if (t === 70) {
    Kp = 2.2;
    llmAdjusted = true;
    llmText.textContent = "LLM: Kp tuned 1.0 → 2.2";
  }

  // 復帰
  if (t > 90) {
    pidText.textContent = "PID: re-tracking target";
  }

  // 波形追加
  pidPoints.push({ x: X(t), y: Y(y) });
  setPoints.push({ x: X(t), y: Y(SETPOINT) });

  pidPath.setAttribute("d", buildPath(pidPoints));
  setPath.setAttribute("d", buildPath(setPoints));

  if (t < 120) requestAnimationFrame(step);
}

step();
</script>

</body>
</html>
