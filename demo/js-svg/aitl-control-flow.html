<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AITL Control Flow Demo — PID × FSM × NN × RL × LLM</title>

<style>
:root{
  --bg:#020617;
  --panel:#0b1222cc;
  --stroke:#38bdf8;
  --muted:#94a3b8;
  --grid:#1f2a44;
  --shadow:0 20px 60px rgba(0,0,0,.55);

  --set:#94a3b8;
  --resp:#38bdf8;
  --dist:#ef444433;
}

*{box-sizing:border-box;}
html,body{
  margin:0;
  background:#000;
  color:#e5e7eb;
  font-family:ui-monospace, Menlo, Consolas, monospace;
}

.wrap{
  max-width:1100px;
  margin:auto;
  padding:14px;
  background:var(--bg);
}

h1{
  font-size:13px;
  letter-spacing:.14em;
  color:#cbd5e1;
  margin-bottom:14px;
}

.panel{
  display:grid;
  grid-template-columns:320px 1fr;
  gap:18px;
}

.card{
  background:linear-gradient(180deg, rgba(11,18,34,.85), rgba(11,18,34,.55));
  border:1px solid rgba(148,163,184,.22);
  border-radius:16px;
  box-shadow:var(--shadow);
  overflow:hidden;
}

.cardHeader{
  padding:14px;
  border-bottom:1px solid rgba(148,163,184,.14);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.pulse{
  width:8px;height:8px;border-radius:50%;
  background:#38bdf8;
  box-shadow:0 0 10px #38bdf8;
  animation:pulse 1.2s infinite;
}
@keyframes pulse{50%{opacity:.4}}

.badge{
  font-size:11px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.22);
}

.status{padding:14px;font-size:12px;}
.row{
  display:flex;justify-content:space-between;
  padding:8px 10px;margin-bottom:8px;
  border-radius:10px;
  background:rgba(2,6,23,.35);
  border:1px solid rgba(148,163,184,.12);
}

.kpi{
  margin-top:10px;
  padding:10px;
  border-radius:10px;
  background:rgba(2,6,23,.35);
  border:1px solid rgba(148,163,184,.12);
}
.kpi .label{font-size:11px;color:var(--muted);}
.kpi .num{font-size:16px;margin-top:4px;}

.footer{
  padding:10px 14px;
  font-size:11px;
  color:var(--muted);
  border-top:1px solid rgba(148,163,184,.14);
}

.svgWrap{position:relative;}
.legend{
  position:absolute;
  top:12px;left:14px;
  font-size:11px;color:var(--muted);
  display:flex;gap:10px;
}
.chip{
  padding:6px 10px;border-radius:999px;
  background:rgba(2,6,23,.35);
  border:1px solid rgba(148,163,184,.18);
}
.sw{width:10px;height:10px;border-radius:3px;display:inline-block;margin-right:6px;}
</style>
</head>

<body>
<div class="wrap">
<h1>AITL CONTROL FLOW DEMO — PID × FSM × NN × RL × LLM</h1>

<div class="panel">

<!-- STATUS -->
<div class="card">
  <div class="cardHeader">
    <div style="display:flex;align-items:center;gap:8px">
      <span class="pulse"></span>LIVE
    </div>
    <span class="badge">FSM is the sole decision authority</span>
  </div>

  <div class="status">
    <div class="row"><span>FSM State</span><span id="fsm">NORMAL</span></div>
    <div class="row"><span>PID</span><span id="pid">tracking</span></div>
    <div class="row"><span>NN</span><span id="nn">idle</span></div>
    <div class="row"><span>RL</span><span id="rl">idle</span></div>
    <div class="row"><span>LLM</span><span id="llm">idle</span></div>

    <div class="kpi">
      <div class="label">Normalized error |e| (FSM trigger: |e| &gt; 0.25)</div>
      <div class="num" id="err">0.00</div>
    </div>
  </div>

  <div class="footer">
    NN / RL propose only. FSM evaluates and authorizes.  
    LLM is invoked only when control logic must be reconsidered.
  </div>
</div>

<!-- GRAPH -->
<div class="card svgWrap">
  <div class="legend">
    <div class="chip"><span class="sw" style="background:var(--set)"></span>Setpoint</div>
    <div class="chip"><span class="sw" style="background:var(--resp)"></span>Response</div>
    <div class="chip"><span class="sw" style="background:#ef4444"></span>Disturbance</div>
  </div>

  <svg viewBox="0 0 860 300">
    <defs>
      <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
        <path d="M40 0 L0 0 0 40" stroke="rgba(31,42,68,.8)" fill="none"/>
      </pattern>
    </defs>

    <rect width="860" height="300" fill="url(#grid)"/>
    <rect x="40" y="20" width="800" height="240" rx="10"
          fill="rgba(2,6,23,.35)" stroke="rgba(148,163,184,.22)"/>

    <!-- disturbance -->
    <rect id="dist" y="20" height="240" fill="var(--dist)" visibility="hidden"/>

    <path id="setPath" stroke="#94a3b8" stroke-dasharray="6 6" fill="none"/>
    <path id="pidPath" stroke="#38bdf8" stroke-width="3" fill="none"/>
  </svg>
</div>

</div>
</div>

<script>
const N=240, SET=1.0;
const X0=40,Y0=20,W=800,H=240;
const DIST_START=70, DIST_END=120;

const fsmEl=fsm=document.getElementById("fsm");
const pidEl=document.getElementById("pid");
const nnEl=document.getElementById("nn");
const rlEl=document.getElementById("rl");
const llmEl=document.getElementById("llm");
const errEl=document.getElementById("err");

const pidPath=document.getElementById("pidPath");
const setPath=document.getElementById("setPath");
const distEl=document.getElementById("dist");

let i=0, Kp=0.9, fsmState="NORMAL";
const px=[], sx=[];
const X=i=>X0+(i/(N-1))*W;
const Y=v=>Y0+H-(v*H);
const path=(p,n)=>n<2?"":"M "+p.slice(0,n).map(q=>q.x+" "+q.y).join(" L ");

function step(){
  let y=SET*(1-Math.exp(-Kp*i/18));
  const disturbed=(i>DIST_START && i<DIST_END);
  if(disturbed) y-=0.32;

  const e=Math.abs(SET-y);
  errEl.textContent=e.toFixed(2);

  if(disturbed && i===DIST_START){
    distEl.setAttribute("x",X(DIST_START));
    distEl.setAttribute("width",X(DIST_END)-X(DIST_START));
    distEl.setAttribute("visibility","visible");
    fsmState="DISTURBANCE_DETECTED";
  }

  if(fsmState==="DISTURBANCE_DETECTED" && e>0.25){
    fsmState="SAFE_CONTROL";
    nnEl.textContent="proposal: gain up";
    rlEl.textContent="evaluating";
    Kp=2.1;
  }

  if(!disturbed && fsmState==="SAFE_CONTROL" && e<0.1){
    fsmState="NORMAL";
    nnEl.textContent="idle";
    rlEl.textContent="idle";
    distEl.setAttribute("visibility","hidden");
    Kp=0.9;
  }

  fsmEl.textContent=fsmState;
  pidEl.textContent=fsmState==="NORMAL"?"tracking":"adjusting";

  px[i]={x:X(i),y:Y(Math.max(0,Math.min(1.05,y)))};
  sx[i]={x:X(i),y:Y(SET)};
  pidPath.setAttribute("d",path(px,i+1));
  setPath.setAttribute("d",path(sx,i+1));

  i++;
  if(i>=N){i=0;px.length=0;sx.length=0;fsmState="NORMAL";}
  requestAnimationFrame(step);
}
step();
</script>
</body>
</html>
