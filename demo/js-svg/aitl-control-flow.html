<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AITL Control Flow (Looping Neon)</title>

<style>
:root{
  --bg:#020617;
  --panel:#0b1222cc;
  --stroke:#38bdf8;
  --muted:#94a3b8;
  --grid:#1f2a44;
  --danger:#ef4444;
  --shadow: 0 20px 60px rgba(0,0,0,.55);
}

*{ box-sizing:border-box; }

html, body{
  margin:0;
  padding:0;
  background:
    radial-gradient(1200px 700px at 50% -10%, rgba(56,189,248,.12), transparent 55%),
    radial-gradient(900px 600px at 15% 10%, rgba(34,197,94,.08), transparent 55%),
    radial-gradient(900px 600px at 85% 20%, rgba(239,68,68,.07), transparent 55%),
    var(--bg);
  color:#e5e7eb;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
}

.wrap{
  max-width:980px;
  margin:0 auto;
}

h1{
  font-size:14px;
  letter-spacing:.14em;
  text-transform:uppercase;
  margin:14px 0;
  color:#cbd5e1;
}

.panel{
  display:grid;
  grid-template-columns:280px 1fr;
  gap:18px;
  align-items:start; /* ← stretch禁止 */
}

.card{
  background: linear-gradient(180deg, rgba(11,18,34,.85), rgba(11,18,34,.55));
  border:1px solid rgba(148,163,184,.22);
  border-radius:16px;
  box-shadow:var(--shadow);
  backdrop-filter:blur(10px);
  overflow:hidden;
}

.cardHeader{
  padding:14px;
  border-bottom:1px solid rgba(148,163,184,.14);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.pulseDot{
  width:8px; height:8px;
  border-radius:50%;
  background:#38bdf8;
  box-shadow:0 0 12px #38bdf8;
  animation:pulse 1.2s infinite;
  margin-right:8px;
}
@keyframes pulse{
  0%,100%{opacity:.9;}
  50%{opacity:.4;}
}

.badge{
  font-size:11px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.22);
}

.status{
  padding:14px;
  font-size:12.5px;
}

.row{
  display:flex;
  justify-content:space-between;
  padding:8px 10px;
  margin-bottom:8px;
  border-radius:10px;
  border:1px solid rgba(148,163,184,.12);
  background:rgba(2,6,23,.35);
}

.kpi{
  margin-top:10px;
  padding:10px;
  border-radius:10px;
  border:1px solid rgba(148,163,184,.12);
  background:rgba(2,6,23,.35);
}

.kpi .label{font-size:11px;color:var(--muted);}
.kpi .num{font-size:16px;margin-top:4px;}

.footerNote{
  padding:10px 14px;
  border-top:1px solid rgba(148,163,184,.14);
  font-size:11px;
  color:var(--muted);
}

.svgWrap{
  padding:0;
}

svg{
  display:block;
  width:100%;
  height:300px; /* ← 余白を作らない高さ */
  background:#020617;
}

.legend{
  position:absolute;
  left:14px;
  top:12px;
  font-size:11px;
  color:var(--muted);
  display:flex;
  gap:10px;
}

.chip{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.18);
  background:rgba(2,6,23,.35);
  display:flex;
  align-items:center;
  gap:6px;
}

.swatch{
  width:10px;height:10px;border-radius:3px;
}
.sw1{background:#94a3b8;}
.sw2{background:#38bdf8;}
</style>
</head>

<body>
<div class="wrap">
  <h1>AITL Control Flow Demo</h1>

  <div class="panel">

    <!-- STATUS -->
    <div class="card">
      <div class="cardHeader">
        <div style="display:flex;align-items:center;">
          <span class="pulseDot"></span>LIVE
        </div>
        <span class="badge">PID × FSM × LLM</span>
      </div>

      <div class="status">
        <div class="row"><span>PID</span><span id="pid">tracking</span></div>
        <div class="row"><span>FSM</span><span id="fsm">monitoring</span></div>
        <div class="row"><span>LLM</span><span id="llm">idle</span></div>

        <div class="kpi">
          <div class="label">error |e| (normalized)</div>
          <div class="num" id="errNum">0.00</div>
        </div>
      </div>

      <div class="footerNote">
        FSM detects degradation → LLM retunes gains → PID recovers
      </div>
    </div>

    <!-- SVG -->
    <div class="card svgWrap" style="position:relative;">
      <div class="legend">
        <div class="chip"><span class="swatch sw1"></span>Setpoint</div>
        <div class="chip"><span class="swatch sw2"></span>Response</div>
      </div>

      <svg viewBox="0 0 860 300" preserveAspectRatio="none">
        <defs>
          <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
            <path d="M40 0 L0 0 0 40" stroke="rgba(31,42,68,.8)" fill="none"/>
          </pattern>
        </defs>

        <rect width="860" height="300" fill="url(#grid)"/>
        <rect x="40" y="20" width="800" height="240" rx="10"
              fill="rgba(2,6,23,.35)" stroke="rgba(148,163,184,.22)"/>

        <path id="setpoint" stroke="#94a3b8" stroke-dasharray="6 6" fill="none"/>
        <path id="pidPath" stroke="#38bdf8" stroke-width="3" fill="none"/>
      </svg>
    </div>

  </div>
</div>

<script>
const N=240, SET=1.0;
const X0=40,Y0=20,W=800,H=240;
const pid=document.getElementById("pidPath");
const set=document.getElementById("setpoint");
const err=document.getElementById("errNum");

let i=0, Kp=0.9;
const px=[], sx=[];

const X=i=>X0+(i/(N-1))*W;
const Y=v=>Y0+H-(v*H);

function path(p,n){
  return "M "+p.slice(0,n).map(q=>q.x+" "+q.y).join(" L ");
}

function step(){
  let y=SET*(1-Math.exp(-Kp*i/18));
  if(i>70&&i<115) y-=0.32;
  if(i===150) Kp=2.1;

  err.textContent=Math.abs(SET-y).toFixed(2);

  px[i]={x:X(i),y:Y(Math.max(0,Math.min(1.05,y)))};
  sx[i]={x:X(i),y:Y(SET)};

  pid.setAttribute("d",path(px,i+1));
  set.setAttribute("d",path(sx,i+1));

  i++;
  if(i>=N){i=0;Kp=0.9;px.length=0;sx.length=0;}
  requestAnimationFrame(step);
}
step();
</script>
</body>
</html>
