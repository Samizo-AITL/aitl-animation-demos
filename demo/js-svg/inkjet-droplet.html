<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inkjet Droplet Formation (More Realistic)</title>
<style>
body {
  margin:0;
  background:#020617;
  color:#e5e7eb;
  font-family: monospace;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:20px;
}

h1 { font-size:16px; margin-bottom:10px; }

svg {
  background:#020617;
  border:1px solid #334155;
}

.nozzle { fill:#64748b; }
.jet { fill:#38bdf8; }
.drop { fill:#38bdf8; }
.sat  { fill:#94a3b8; }
</style>
</head>

<body>
<h1>Inkjet Droplet Formation (Realistic-ish)</h1>

<svg width="400" height="520" viewBox="0 0 400 520">
  <!-- ノズル -->
  <rect class="nozzle" x="160" y="20" width="80" height="40"/>

  <!-- 液柱 -->
  <rect id="jet" class="jet" x="188" y="60" width="24" height="0"/>

  <!-- 主液滴 -->
  <ellipse id="drop" class="drop" cx="200" cy="120" rx="16" ry="16" opacity="0"/>

  <!-- サテライト -->
  <circle id="sat1" class="sat" cx="200" cy="110" r="4" opacity="0"/>
  <circle id="sat2" class="sat" cx="200" cy="100" r="3" opacity="0"/>
</svg>

<script>
const jet  = document.getElementById("jet");
const drop = document.getElementById("drop");
const s1   = document.getElementById("sat1");
const s2   = document.getElementById("sat2");

let t = 0;

/* 状態 */
let dropY = 120;
let vDrop = 0;

let sat1Y = 110, vS1 = 0;
let sat2Y = 100, vS2 = 0;

function reset() {
  t = 0;
  jet.setAttribute("height", 0);
  jet.setAttribute("width", 24);

  drop.setAttribute("opacity", 0);
  s1.setAttribute("opacity", 0);
  s2.setAttribute("opacity", 0);

  dropY = 120; vDrop = 0;
  sat1Y = 110; vS1 = 0;
  sat2Y = 100; vS2 = 0;
}

function step() {
  t++;

  /* ---- Phase 1: 液柱伸長 ---- */
  if (t < 30) {
    const h = t * 3;
    jet.setAttribute("height", h);
  }

  /* ---- Phase 2: ネック形成（非線形収縮） ---- */
  if (t >= 30 && t < 55) {
    const dt = t - 30;
    const h = 90 + dt * 1.2;
    jet.setAttribute("height", h);

    /* ネック半径減少 */
    const w = 24 - dt * 0.6;
    jet.setAttribute("width", Math.max(w, 2));
    jet.setAttribute("x", 200 - Math.max(w,2)/2);

    drop.setAttribute("opacity", 1);
    drop.setAttribute("cy", 60 + h);
  }

  /* ---- Phase 3: ピンチオフ ---- */
  if (t === 55) {
    jet.setAttribute("height", 60);
    jet.setAttribute("width", 6);
    jet.setAttribute("x", 197);

    drop.setAttribute("opacity", 1);
    s1.setAttribute("opacity", 1);
    s2.setAttribute("opacity", 1);

    /* 初速付与 */
    vDrop = 2.8;
    vS1   = 2.2;
    vS2   = 1.6;
  }

  /* ---- Phase 4: 飛翔＋振動 ---- */
  if (t > 55 && t < 140) {
    /* 主滴 */
    vDrop += 0.05;
    dropY += vDrop;
    drop.setAttribute("cy", dropY);

    /* Rayleigh振動（減衰） */
    const osc = Math.exp(-(t-55)/40) * Math.sin((t-55)/4);
    const rx = 16 + osc * 2.5;
    const ry = 16 - osc * 2.5;
    drop.setAttribute("rx", rx);
    drop.setAttribute("ry", ry);

    /* サテライト */
    vS1 += 0.04;  sat1Y += vS1;
    vS2 += 0.03;  sat2Y += vS2;

    s1.setAttribute("cy", sat1Y);
    s2.setAttribute("cy", sat2Y);
  }

  /* ---- Loop ---- */
  if (t > 180) reset();

  requestAnimationFrame(step);
}

step();
</script>
</body>
</html>
