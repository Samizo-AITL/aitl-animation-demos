<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inkjet Demo (Cinematic) — Left→Right</title>
<style>
  :root{ --bg:#020617; --fg:#e5e7eb; --line:#334155; --noz:#64748b; }
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    display:flex; flex-direction:column; align-items:center; gap:10px; padding:16px;
  }
  h1{margin:0; font-size:14px; font-weight:600; opacity:.95}
  .panel{
    width:min(980px, 96vw);
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    border:1px solid var(--line); border-radius:12px; padding:10px;
    background:rgba(2,6,23,0.4);
  }
  label{display:flex; gap:8px; align-items:center; font-size:12px}
  input[type="range"]{width:190px}
  button{
    background:transparent; color:var(--fg);
    border:1px solid var(--line); border-radius:12px;
    padding:6px 10px; cursor:pointer;
  }
  button:hover{border-color:#64748b}
  svg{
    width:min(980px, 96vw); height:auto;
    background:var(--bg);
    border:1px solid var(--line);
    border-radius:16px;
    display:block;
  }
  .hint{width:min(980px,96vw); font-size:12px; opacity:.85; line-height:1.5}
</style>
</head>
<body>
<h1>Inkjet Demo (Cinematic) — 演出100% / 物理0%（左→右）</h1>

<div class="panel">
  <label>intensity
    <input id="intensity" type="range" min="0.6" max="2.2" step="0.05" value="1.35">
    <span id="intV"></span>
  </label>
  <label>speed
    <input id="speed" type="range" min="0.7" max="2.2" step="0.05" value="1.15">
    <span id="spdV"></span>
  </label>
  <label>spray
    <input id="spray" type="range" min="0" max="1" step="0.05" value="0.55">
    <span id="sprV"></span>
  </label>
  <label>cycle
    <input id="cycle" type="range" min="160" max="420" step="10" value="240">
    <span id="cycV"></span>
  </label>
  <button id="resetBtn">reset</button>
  <button id="pauseBtn">pause</button>
</div>

<div class="hint">
  ・これは“演出用”です。液柱は「刃物みたいな先端」、液滴は「速度で横長化」、着弾は「派手なスプラッシュ」。<br>
  ・intensity を上げると、押し出し感・グロー・スプラッシュが増えます。
</div>

<svg id="svg" viewBox="0 0 980 420" aria-label="inkjet cinematic demo">
  <defs>
    <!-- ink -->
    <radialGradient id="inkGrad" cx="35%" cy="30%" r="85%">
      <stop offset="0%" stop-color="#dbeafe"/>
      <stop offset="55%" stop-color="#38bdf8"/>
      <stop offset="100%" stop-color="#0284c7"/>
    </radialGradient>

    <!-- highlight (specular-ish) -->
    <linearGradient id="specGrad" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0" stop-color="rgba(255,255,255,0.0)"/>
      <stop offset="0.45" stop-color="rgba(255,255,255,0.55)"/>
      <stop offset="0.65" stop-color="rgba(255,255,255,0.0)"/>
    </linearGradient>

    <!-- glow -->
    <filter id="glow">
      <feGaussianBlur stdDeviation="2.4" result="b"/>
      <feMerge>
        <feMergeNode in="b"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>

    <!-- strong glow for impact -->
    <filter id="hotglow">
      <feGaussianBlur stdDeviation="4.2" result="b"/>
      <feMerge>
        <feMergeNode in="b"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>

    <!-- vignette -->
    <radialGradient id="vignette" cx="50%" cy="50%" r="75%">
      <stop offset="55%" stop-color="rgba(0,0,0,0)"/>
      <stop offset="100%" stop-color="rgba(0,0,0,0.55)"/>
    </radialGradient>

    <!-- grid -->
    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
      <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#0b1220" stroke-width="1"/>
    </pattern>

    <!-- metal -->
    <linearGradient id="metal" x1="0" x2="1">
      <stop offset="0" stop-color="#6b7280"/>
      <stop offset="0.5" stop-color="#94a3b8"/>
      <stop offset="1" stop-color="#64748b"/>
    </linearGradient>
  </defs>

  <rect x="0" y="0" width="980" height="420" fill="url(#grid)"/>
  <rect x="0" y="0" width="980" height="420" fill="url(#vignette)"/>

  <!-- substrate (closer for punchy visuals) -->
  <g id="substrateG">
    <rect id="substrate" x="700" y="40" width="56" height="340" rx="12" fill="#0b1220" stroke="#1f2937"/>
    <text x="728" y="28" text-anchor="middle" font-size="12" fill="#94a3b8">substrate</text>
  </g>

  <!-- nozzle -->
  <g id="nozzleG">
    <rect x="40" y="150" width="90" height="120" rx="12" fill="url(#metal)" opacity="0.98"/>
    <rect x="130" y="205" width="14" height="10" rx="2" fill="#475569"/>
    <rect x="124" y="196" width="10" height="28" rx="4" fill="#111827" opacity="0.55"/>
  </g>

  <!-- meniscus -->
  <path id="meniscus" fill="url(#inkGrad)" filter="url(#glow)" d=""/>

  <!-- jet blade -->
  <path id="jet" fill="url(#inkGrad)" filter="url(#glow)" d=""/>

  <!-- jet spec highlight -->
  <path id="jetSpec" fill="url(#specGrad)" opacity="0.0" d=""/>

  <!-- motion streak -->
  <path id="streak" fill="url(#inkGrad)" opacity="0.0" d=""/>

  <!-- droplets -->
  <g id="drops"></g>

  <!-- particles -->
  <g id="particles"></g>

  <!-- impacts -->
  <g id="impacts"></g>

  <text x="160" y="28" font-size="12" fill="#94a3b8">demo: cinematic animation</text>
</svg>

<script>
(() => {
  // ========= DOM =========
  const meniscus = document.getElementById("meniscus");
  const jet = document.getElementById("jet");
  const jetSpec = document.getElementById("jetSpec");
  const streak = document.getElementById("streak");
  const dropsG = document.getElementById("drops");
  const particlesG = document.getElementById("particles");
  const impactsG = document.getElementById("impacts");
  const substrate = document.getElementById("substrate");

  const $ = (id)=>document.getElementById(id);
  const intS=$("intensity"), spdS=$("speed"), sprS=$("spray"), cycS=$("cycle");
  const intV=$("intV"), spdV=$("spdV"), sprV=$("sprV"), cycV=$("cycV");
  const resetBtn=$("resetBtn"), pauseBtn=$("pauseBtn");

  // ========= Params (animation-first) =========
  const P = {
    nozzleX: 144, nozzleY: 210,
    menH: 22,
    substrateX: 700,
    cycle: 240,

    intensity: 1.35,
    speed: 1.15,
    spray: 0.55,

    // look constants
    jetMaxLen: 250,
    jetMinNeck: 2.2,
    jetBaseNeck: 14,
  };

  function bind(sl,out,key,fmt=2){
    const upd=()=>{ P[key]=Number(sl.value); out.textContent=Number(sl.value).toFixed(fmt); };
    sl.addEventListener("input",upd); upd();
  }
  bind(intS,intV,"intensity",2);
  bind(spdS,spdV,"speed",2);
  bind(sprS,sprV,"spray",2);
  bind(cycS,cycV,"cycle",0);

  function syncSubstrate(){
    substrate.setAttribute("x", P.substrateX);
  }
  syncSubstrate();

  // ========= Helpers =========
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  let seed=1234567;
  const rand=()=>((seed=(seed*1664525+1013904223)>>>0)/4294967296);
  const TAU = Math.PI*2;

  function clear(g){
    while(g.firstChild) g.removeChild(g.firstChild);
  }

  // Meniscus shape (visual only)
  function meniscusPath(x, amp){
    const h=P.menH;
    const y0=P.nozzleY-h, y1=P.nozzleY+h;
    return `
      M ${x} ${y0}
      Q ${x+amp} ${P.nozzleY} ${x} ${y1}
      L ${x+2} ${y1}
      Q ${x+amp+2} ${P.nozzleY} ${x+2} ${y0}
      Z
    `;
  }

  // Jet “blade” (sharp tip) shape (visual only)
  function jetBladePath(x0, len, neck){
    const xTip = x0 + len;
    const yT = P.nozzleY - neck;
    const yB = P.nozzleY + neck;

    // Make tip sharp (triangle-ish) and tail fat
    const tailBulge = clamp(22 + len*0.08, 22, 60);
    const midX = x0 + len*0.72;

    return `
      M ${x0} ${yT}
      C ${x0+tailBulge} ${yT-2}, ${midX} ${yT-10}, ${xTip} ${P.nozzleY}
      C ${midX} ${yB+10}, ${x0+tailBulge} ${yB+2}, ${x0} ${yB}
      Z
    `;
  }

  // Streak (motion blur) behind main droplet
  function streakPath(x, y, vx){
    const L = clamp(30 + vx*18, 30, 220);
    const w = clamp(6 + vx*2.2, 6, 26);
    const x0 = x - L;
    return `
      M ${x0} ${y-w}
      Q ${x - L*0.55} ${y-w*1.2}, ${x} ${y}
      Q ${x - L*0.55} ${y+w*1.2}, ${x0} ${y+w}
      Z
    `;
  }

  function makeEl(tag){ return document.createElementNS("http://www.w3.org/2000/svg", tag); }

  function makeMainDrop(){
    const e = makeEl("ellipse");
    e.setAttribute("fill","url(#inkGrad)");
    e.setAttribute("filter","url(#glow)");
    dropsG.appendChild(e);

    const spec = makeEl("ellipse");
    spec.setAttribute("fill","rgba(255,255,255,0.35)");
    spec.setAttribute("opacity","0.0");
    dropsG.appendChild(spec);

    return { e, spec };
  }

  function makeSatDrop(){
    const c = makeEl("circle");
    c.setAttribute("fill","url(#inkGrad)");
    c.setAttribute("filter","url(#glow)");
    dropsG.appendChild(c);
    return c;
  }

  function spawnParticles(x,y,amount,baseV){
    // burst particles (impact or pinch)
    for(let i=0;i<amount;i++){
      const p = makeEl("circle");
      p.setAttribute("cx",x);
      p.setAttribute("cy",y);
      p.setAttribute("r", 0.6 + rand()*1.8);
      p.setAttribute("fill","url(#inkGrad)");
      p.setAttribute("filter","url(#hotglow)");
      p.setAttribute("opacity","0.9");
      particlesG.appendChild(p);

      const ang = rand()*TAU;
      const v = baseV*(0.5 + rand()*1.0);
      const vx = Math.cos(ang)*v;
      const vy = Math.sin(ang)*v;

      particles.push({ el:p, x, y, vx, vy, life: 0, ttl: 24 + rand()*18 });
    }
  }

  function spawnImpact(x,y,scale){
    // “ink splat” + ring + spark
    const g = makeEl("g");

    const e = makeEl("ellipse");
    e.setAttribute("cx",x); e.setAttribute("cy",y);
    e.setAttribute("rx", 2.5*scale); e.setAttribute("ry", 2.0*scale);
    e.setAttribute("fill","url(#inkGrad)");
    e.setAttribute("filter","url(#hotglow)");
    e.setAttribute("opacity","0.95");
    g.appendChild(e);

    const ring = makeEl("ellipse");
    ring.setAttribute("cx",x); ring.setAttribute("cy",y);
    ring.setAttribute("rx", 3.0*scale); ring.setAttribute("ry", 2.4*scale);
    ring.setAttribute("fill","none");
    ring.setAttribute("stroke","rgba(255,255,255,0.35)");
    ring.setAttribute("stroke-width","1");
    ring.setAttribute("opacity","0.8");
    g.appendChild(ring);

    impactsG.appendChild(g);
    impacts.push({ g, e, ring, life:0, scale });
    spawnParticles(x,y, 12 + Math.floor(14*P.spray), 2.6*scale);
  }

  // ========= State =========
  let running = true;
  let t = 0;

  // main drop state
  const mainDrop = makeMainDrop();
  const sat1 = makeSatDrop();
  const sat2 = makeSatDrop();

  let main = { x:P.nozzleX+40, y:P.nozzleY, vx:0, vy:0, alive:false };
  let sat = { x:0,y:0, vx:0,vy:0, x2:0,y2:0, vx2:0,vy2:0, alive:false };

  // particles & impacts
  const particles = [];
  const impacts = [];

  // timeline markers (visual story beats)
  const BEAT = {
    pullEnd: 18,
    pushEnd: 44,
    pinch: 52,         // force pinch time
    flightEnd: 140,    // after this, fade jet
  };

  // ========= Reset =========
  function reset(){
    t = 0;
    clear(particlesG);
    clear(impactsG);
    particles.length = 0;
    impacts.length = 0;

    main = { x:P.nozzleX+40, y:P.nozzleY, vx:0, vy:0, alive:false };
    sat = { x:0,y:0, vx:0,vy:0, x2:0,y2:0, vx2:0,vy2:0, alive:false };

    // init draw
    meniscus.setAttribute("d", meniscusPath(P.nozzleX, 0));
    jet.setAttribute("d", "");
    jetSpec.setAttribute("d", "");
    jetSpec.setAttribute("opacity","0");
    streak.setAttribute("d", "");
    streak.setAttribute("opacity","0");

    mainDrop.e.setAttribute("opacity","0");
    mainDrop.spec.setAttribute("opacity","0");
    sat1.setAttribute("opacity","0");
    sat2.setAttribute("opacity","0");
  }

  resetBtn.addEventListener("click", reset);
  pauseBtn.addEventListener("click", ()=>{
    running = !running;
    pauseBtn.textContent = running ? "pause" : "resume";
    if(running) requestAnimationFrame(step);
  });

  // ========= Cinematic “drive” (visual only) =========
  function driveWave(tt){
    // pull -> push -> ring-down (for visuals)
    const g = P.intensity;
    if(tt < BEAT.pullEnd){
      const u = tt/BEAT.pullEnd;
      return -0.9*g*Math.sin(Math.PI*u);
    }
    if(tt < BEAT.pushEnd){
      const u = (tt-BEAT.pullEnd)/(BEAT.pushEnd-BEAT.pullEnd);
      return  1.4*g*Math.sin(Math.PI*u);
    }
    const u = (tt-BEAT.pushEnd);
    return g*Math.exp(-u/30)*Math.sin(u/4.2);
  }

  // ========= Animation core =========
  function step(){
    if(!running) return;

    // time
    t += 1 * P.speed;

    // --- Meniscus (always)
    const w = driveWave(t);
    const menX = P.nozzleX + w*2.6;           // wobble
    const amp  = clamp(w*16, -20, 28);        // bulge
    meniscus.setAttribute("d", meniscusPath(menX, amp));

    // --- Jet (story-driven)
    // Build a sharp jet during push, then neck down, then hide.
    let jetOpacity = 1.0;
    let len = 0;
    let neck = P.jetBaseNeck;

    if(t < BEAT.pinch){
      // length ramps fast during push, slightly retract on pull
      const push = clamp((t - BEAT.pullEnd) / (BEAT.pushEnd - BEAT.pullEnd), 0, 1);
      const pull = clamp(t / BEAT.pullEnd, 0, 1);

      // “snappy” extension for punch
      len = clamp(
        P.jetMaxLen * (0.12 + 0.95 * (push*push)),
        0,
        P.jetMaxLen
      );

      // necking toward pinch
      const neckT = clamp((t - (BEAT.pushEnd-10)) / (BEAT.pinch - (BEAT.pushEnd-10)), 0, 1);
      neck = clamp(P.jetBaseNeck * (1.0 - 0.86*neckT), P.jetMinNeck, P.jetBaseNeck);

      // small ripple to look “liquid”
      neck += Math.sin(t/3.5) * (0.35 * P.intensity) * (1.0-neckT);

      // pull makes it slightly shorter (visual recoil)
      len -= pull*pull * (20*P.intensity);
      len = clamp(len, 0, P.jetMaxLen);

      const path = jetBladePath(menX, len, neck);
      jet.setAttribute("d", path);

      // spec highlight on jet
      jetSpec.setAttribute("d", path);
      jetSpec.setAttribute("opacity", clamp(0.22 + 0.25*push, 0, 0.55));
    } else {
      // after pinch: shrink ligament quickly then fade out
      const u = (t - BEAT.pinch);
      len = clamp(70 - u*1.2, 0, 70);
      neck = clamp(P.jetMinNeck + 2.2, P.jetMinNeck, P.jetBaseNeck);
      jetOpacity = clamp(1 - u/55, 0, 1);

      if(len > 0){
        const path = jetBladePath(menX, len, neck);
        jet.setAttribute("d", path);
        jet.setAttribute("opacity", jetOpacity);
        jetSpec.setAttribute("d", path);
        jetSpec.setAttribute("opacity", 0.18*jetOpacity);
      } else {
        jet.setAttribute("d", "");
        jetSpec.setAttribute("d", "");
        jetSpec.setAttribute("opacity", 0);
      }
    }

    // --- Force “pinch event” exactly once
    if(!main.alive && t >= BEAT.pinch){
      main.alive = true;

      // launch point at jet tip (or close)
      const tipX = menX + clamp(len, 80, P.jetMaxLen) + 14;
      main.x = tipX;
      main.y = P.nozzleY;

      // launch speed: cinematic acceleration
      main.vx = 6.0 * P.speed + 3.0 * P.intensity;
      main.vy = (rand()-0.5) * 0.7;

      // spawn pinch mist (looks great)
      spawnParticles(tipX-12, main.y, 10 + Math.floor(10*P.spray), 1.7);

      // satellites as decoration
      sat.alive = rand() < (0.80 + 0.15*P.spray);
      if(sat.alive){
        sat.x  = tipX - 26; sat.y  = P.nozzleY - 7;
        sat.x2 = tipX - 44; sat.y2 = P.nozzleY + 8;
        sat.vx  = main.vx * 0.88;
        sat.vx2 = main.vx * 0.80;
        sat.vy  = (rand()-0.5) * 1.1;
        sat.vy2 = (rand()-0.5) * 1.1;
      }
    }

    // --- Flight (pure animation)
    if(main.alive){
      // cinematic accel (not physics)
      const accel = 0.18 * P.speed + 0.12 * P.intensity;
      main.vx += accel;

      // depth boost to make it look fast near substrate
      const depth = clamp(main.x / P.substrateX, 0, 1);
      const depthBoost = 1 + depth*0.75;

      main.x += main.vx * depthBoost;
      main.y += main.vy;
      main.vy *= 0.985; // calm

      // keep near center line slightly
      main.y += (P.nozzleY - main.y) * 0.003;

      // droplet shape: speed -> elongation (key!)
      const rx = clamp(18 + main.vx*1.35, 18, 72);
      const ry = clamp(14 - main.vx*0.10, 8.5, 14);

      mainDrop.e.setAttribute("cx", main.x);
      mainDrop.e.setAttribute("cy", main.y);
      mainDrop.e.setAttribute("rx", rx);
      mainDrop.e.setAttribute("ry", ry);
      mainDrop.e.setAttribute("opacity", 1);

      // spec highlight on droplet
      mainDrop.spec.setAttribute("cx", main.x - rx*0.18);
      mainDrop.spec.setAttribute("cy", main.y - ry*0.12);
      mainDrop.spec.setAttribute("rx", rx*0.32);
      mainDrop.spec.setAttribute("ry", ry*0.28);
      mainDrop.spec.setAttribute("opacity", clamp(0.22 + 0.15*P.intensity, 0, 0.5));

      // motion streak
      streak.setAttribute("d", streakPath(main.x - rx*0.25, main.y, main.vx));
      streak.setAttribute("opacity", clamp(0.10 + 0.22*depth + 0.12*P.spray, 0, 0.55));

      // satellites follow behind (decor)
      if(sat.alive){
        const wob = Math.sin(t/4.2) * 0.8;
        sat.x  += sat.vx;  sat.y  += sat.vy + wob;
        sat.x2 += sat.vx2; sat.y2 += sat.vy2 - wob;

        // “magnetic” follow to main
        sat.x  += (main.x - 28 - sat.x) * 0.04;
        sat.y  += (main.y - 8  - sat.y) * 0.05;
        sat.x2 += (main.x - 48 - sat.x2)* 0.04;
        sat.y2 += (main.y + 9  - sat.y2)* 0.05;

        sat1.setAttribute("cx", sat.x);
        sat1.setAttribute("cy", sat.y);
        sat1.setAttribute("r",  clamp(4.1 + P.spray*1.2, 3.6, 6.0));
        sat1.setAttribute("opacity", 0.95);

        sat2.setAttribute("cx", sat.x2);
        sat2.setAttribute("cy", sat.y2);
        sat2.setAttribute("r",  clamp(3.2 + P.spray*1.0, 2.8, 5.0));
        sat2.setAttribute("opacity", 0.85);
      } else {
        sat1.setAttribute("opacity","0");
        sat2.setAttribute("opacity","0");
      }

      // Impact check: guaranteed hit
      if(main.x >= P.substrateX - 2){
        const yHit = clamp(main.y, 60, 360);
        const scale = clamp(0.9 + P.intensity*0.35, 0.9, 1.7);
        spawnImpact(P.substrateX, yHit, scale);

        // fade out this shot quickly
        main.alive = false;
        mainDrop.e.setAttribute("opacity","0");
        mainDrop.spec.setAttribute("opacity","0");
        streak.setAttribute("opacity","0");
        sat.alive = false;
        sat1.setAttribute("opacity","0");
        sat2.setAttribute("opacity","0");
      }
    } else {
      // when no droplet: hide streak
      streak.setAttribute("opacity","0");
      mainDrop.e.setAttribute("opacity","0");
      mainDrop.spec.setAttribute("opacity","0");
    }

    // --- Particles update
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.life += 1;
      // quick expand/fade
      p.x += p.vx;
      p.y += p.vy;
      p.vx *= 0.96;
      p.vy *= 0.96;
      p.el.setAttribute("cx", p.x);
      p.el.setAttribute("cy", p.y);
      p.el.setAttribute("opacity", clamp(1 - p.life/p.ttl, 0, 1));
      if(p.life > p.ttl){
        if(p.el.parentNode) p.el.parentNode.removeChild(p.el);
        particles.splice(i,1);
      }
    }

    // --- Impact animation
    for(let i=impacts.length-1;i>=0;i--){
      const im = impacts[i];
      im.life += 1;
      const grow = 1 + Math.min(3.2, im.life/10);
      const fade = clamp(1 - im.life/80, 0, 1);

      im.e.setAttribute("rx", (2.6*im.scale) * grow);
      im.e.setAttribute("ry", (2.2*im.scale) * grow);
      im.e.setAttribute("opacity", 0.9*fade);

      im.ring.setAttribute("rx", (3.0*im.scale) * (1 + im.life/8));
      im.ring.setAttribute("ry", (2.4*im.scale) * (1 + im.life/8));
      im.ring.setAttribute("opacity", 0.7*fade);

      if(im.life > 120){
        if(im.g.parentNode) im.g.parentNode.removeChild(im.g);
        impacts.splice(i,1);
      }
    }

    // --- Cycle reset
    if(t > P.cycle){
      reset();
    }

    requestAnimationFrame(step);
  }

  reset();
  requestAnimationFrame(step);
})();
</script>
</body>
</html>
