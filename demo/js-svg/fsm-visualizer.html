<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FSM Visualizer</title>

<style>
/* =====================================================
   Global / Fullscreen (GitHub Pages safe)
===================================================== */
html, body {
  width: 100%;
  height: 100vh;          /* ★ 100% は使わない */
  margin: 0;
  overflow: hidden;
  background: #111;
  color: #eee;
  font-family: system-ui, sans-serif;
}

/* =====================================================
   App Layout
===================================================== */
.app {
  width: 100vw;
  height: 100vh;
  display: grid;
  grid-template-rows: 2.2fr 1fr;  /* FSM is the hero */
}

/* =====================================================
   FSM Visualization Area
===================================================== */
.viz {
  display: grid;
  grid-template-rows: auto 1fr auto;
  justify-items: center;
  align-items: center;
}

.title {
  margin-top: 12px;
  font-size: 20px;
  font-weight: 600;
}

/* SVG must fill available space */
svg {
  width: 100%;
  height: 100%;
  display: block;
}

/* FSM graphics */
.state {
  fill: #333;
  stroke: #888;
  stroke-width: 2;
}
.active {
  fill: #1e90ff;
}
.transition {
  stroke: #666;
  stroke-width: 2;
  fill: none;
  marker-end: url(#arrow);
}
.event {
  fill: #ffcc00;
}

/* Controls */
.controls {
  margin-bottom: 14px;
}
button {
  margin: 0 6px;
  padding: 6px 16px;
  font-size: 14px;
  cursor: pointer;
}

/* =====================================================
   Transition Table Area
===================================================== */
.table-panel {
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow: auto;
  border-top: 1px solid #333;
  background: #0d0d0d;
}

.table-title {
  width: 100%;
  max-width: 720px;
  text-align: left;
  padding: 10px 0;
  font-size: 14px;
  font-weight: 600;
}

table {
  width: 100%;
  max-width: 720px;
  border-collapse: collapse;
  font-size: 14px;
  margin-bottom: 14px;
}

th, td {
  border: 1px solid #555;
  padding: 6px 12px;
  text-align: center;
}

th {
  background: #222;
}

.highlight {
  background: #1e90ff;
  color: #000;
}
</style>
</head>

<body>

<div class="app">

  <!-- ================= FSM Visualization ================= -->
  <div class="viz">
    <div class="title">FSM Visualizer — Transition Table Driven</div>

    <svg viewBox="0 0 600 360" aria-label="FSM diagram">
      <defs>
        <marker id="arrow" markerWidth="10" markerHeight="10"
          refX="10" refY="5" orient="auto">
          <path d="M0,0 L10,5 L0,10 z" fill="#666"/>
        </marker>
      </defs>

      <path class="transition" d="M240,180 L360,180"/>

      <circle id="IDLE" class="state active" cx="200" cy="180" r="40"/>
      <text x="200" y="185" text-anchor="middle" fill="#eee">IDLE</text>

      <circle id="RUN" class="state" cx="400" cy="180" r="40"/>
      <text x="400" y="185" text-anchor="middle" fill="#eee">RUN</text>

      <circle id="event" class="event" cx="200" cy="180" r="6"
        visibility="hidden"/>
    </svg>

    <div class="controls">
      <button data-event="START">START</button>
      <button data-event="STOP">STOP</button>
      <button data-event="RESET">RESET</button>
    </div>
  </div>

  <!-- ================= Transition Table ================= -->
  <div class="table-panel">
    <div class="table-title">FSM Transition Table</div>

    <table id="fsmTable">
      <tr>
        <th>State \\ Event</th>
        <th>START</th>
        <th>STOP</th>
        <th>RESET</th>
      </tr>
      <tr>
        <th>IDLE</th>
        <td>RUN</td>
        <td>—</td>
        <td>IDLE</td>
      </tr>
      <tr>
        <th>RUN</th>
        <td>—</td>
        <td>IDLE</td>
        <td>IDLE</td>
      </tr>
    </table>
  </div>

</div>

<script>
console.log("FSM visualizer loaded");

/* =====================================
   FSM definition
===================================== */
const FSM = {
  IDLE: {
    START: "RUN",
    RESET: "IDLE"
  },
  RUN: {
    STOP: "IDLE",
    RESET: "IDLE"
  }
};

let currentState = "IDLE";

/* SVG coordinates (viewBox based) */
const POS = {
  IDLE_X: 200,
  RUN_X: 400,
  Y: 180
};

const SPEED = 5;
const INTERVAL = 20;

/* =====================================
   DOM ready
===================================== */
window.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("button[data-event]").forEach(btn => {
    btn.addEventListener("click", () => {
      dispatch(btn.dataset.event);
    });
  });
});

/* =====================================
   FSM dispatcher
===================================== */
function dispatch(event) {
  clearHighlight();

  const next = FSM[currentState]?.[event];
  if (!next) {
    rejectEvent();
    return;
  }

  highlightTable(currentState, event);
  animateEvent(next);
}

/* =====================================
   Animation
===================================== */
function animateEvent(nextState) {
  const e = document.getElementById("event");
  e.setAttribute("visibility", "visible");
  e.setAttribute("fill", "#ffcc00");
  e.setAttribute("cx", POS.IDLE_X);
  e.setAttribute("cy", POS.Y);

  let x = POS.IDLE_X;
  const timer = setInterval(() => {
    x += SPEED;
    e.setAttribute("cx", x);

    if (x >= POS.RUN_X) {
      clearInterval(timer);
      e.setAttribute("visibility", "hidden");
      transitionTo(nextState);
    }
  }, INTERVAL);
}

function transitionTo(next) {
  document.getElementById(currentState).classList.remove("active");
  document.getElementById(next).classList.add("active");
  currentState = next;
  console.log("FSM state =", currentState);
}

/* =====================================
   Reject visualization
===================================== */
function rejectEvent() {
  const e = document.getElementById("event");
  e.setAttribute("visibility", "visible");
  e.setAttribute("fill", "#ff4444");

  setTimeout(() => {
    e.setAttribute("visibility", "hidden");
    e.setAttribute("fill", "#ffcc00");
  }, 300);

  console.log("Rejected event in state:", currentState);
}

/* =====================================
   Table highlight
===================================== */
function clearHighlight() {
  document.querySelectorAll(".highlight")
    .forEach(td => td.classList.remove("highlight"));
}

function highlightTable(state, event) {
  const table = document.getElementById("fsmTable");
  const rows = [...table.rows];
  const header = rows[0];
  const stateRow = rows.find(r => r.cells[0]?.innerText === state);
  if (!stateRow) return;

  const col = [...header.cells].findIndex(h => h.innerText === event);
  if (col > 0) {
    stateRow.cells[col].classList.add("highlight");
  }
}
</script>

</body>
</html>
